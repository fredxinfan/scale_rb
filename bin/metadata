#!/usr/bin/env ruby

require 'bundler/setup'
require 'scale_rb_2'

require 'uri'
require 'net/http'
require 'json'

def print_metadata(url, block_hash = nil)
  uri = URI(url)
  req = Net::HTTP::Post.new(uri, 'Content-Type' => 'application/json')
  req.body = { 'id' => 1, 'jsonrpc' => '2.0', 'method' => 'state_getMetadata',
               'params' => [block_hash] }.to_json
  http = Net::HTTP.new(uri.host, uri.port)
  res = http.request(req)

  raise res.to_s unless res.is_a?(Net::HTTPSuccess)

  result = JSON.parse(res.body)
  if result['result']
    metadata_hex = result['result'].strip
    metadata = ScaleRb2.decode_metadata(metadata_hex.to_bytes)
    puts JSON.pretty_generate(metadata)
  else
    puts result
  end
end

# print_metadata('http://g2.dev.darwinia.network:2234', '0x23ebddd6519aaf1b7fc916c3709af13d7a4010943fb53038406581171000a58e')
print_metadata('http://g2.dev.darwinia.network:1234', '0x9718e53763eda892a3c5489247febdfeb6e4db44c25efe60d8ebc0bbef06c325')
